set schema 'zafira';

select check_version(83);

-- ATTENTION!! PLEASE REMOVE MANUALLY EXISTING MATERIALIZED VIEW AND BELOW CRON QUERY
-- SELECT cron.schedule ('0 7 * * *', $$REFRESH MATERIALIZED VIEW ZAFIRA.NIGHTLY_FAILURES_VIEW$$);

DROP VIEW IF EXISTS NIGHTLY_FAILURES_VIEW;
CREATE VIEW NIGHTLY_FAILURES_VIEW AS (
  SELECT
    row_number() OVER () AS ID,
    PROJECTS.NAME AS PROJECT,
    TESTS.ID AS TEST_ID,
    TESTS.NAME AS TEST_NAME,
    USERS.ID AS OWNER_ID,
    USERS.USERNAME AS OWNER,
    USERS.EMAIL AS EMAIL,
    TEST_RUNS.ENV AS ENV,
    TEST_CONFIGS.PLATFORM AS PLATFORM,
    TEST_CONFIGS.BROWSER AS BROWSER,
    JOBS.JOB_URL AS JOB_URL,
    JOBS.NAME AS JOB_NAME,
    TEST_SUITES.NAME AS TEST_SUITE_NAME,
    TEST_RUNS.BUILD_NUMBER AS JOBBUILD,
    '<a href="{#zafiraURL}#!/tests/runs/' || TEST_RUNS.ID || '" target="_blank">' || JOBS.NAME || '</a>' AS REPORT,
    '<a href="' || JOBS.JOB_URL || '/' || TEST_RUNS.build_number || '/eTAF_Report' || '" target="_blank">' || JOBS.NAME || '</a>' AS ETAF_REPORT,
    '<a href="' || JOBS.JOB_URL || '/' || TEST_RUNS.build_number || '/rebuild/parameterized' || '" target="_blank">Rebuild</a>' AS REBUILD,
    TEST_RUNS.ID AS TEST_RUN_ID,
    TEST_RUNS.UPSTREAM_JOB_ID AS UPSTREAM_JOB_ID,
    TEST_RUNS.UPSTREAM_JOB_BUILD_NUMBER AS UPSTREAM_JOB_BUILD_NUMBER,
    TESTS.MESSAGE AS MESSAGE,
    TESTS.MESSAGE_HASH_CODE AS MESSAGE_HASHCODE,
    TESTS.BLOCKER AS TEST_BLOCKER,
    TESTS.KNOWN_ISSUE AS TEST_KNOWN_ISSUE
  FROM TESTS
    JOIN TEST_RUNS ON TEST_RUNS.ID = TESTS.TEST_RUN_ID
    JOIN TEST_CASES ON TESTS.TEST_CASE_ID = TEST_CASES.ID
    LEFT JOIN PROJECTS ON TEST_CASES.PROJECT_ID = PROJECTS.ID
    JOIN USERS ON TEST_CASES.PRIMARY_OWNER_ID = USERS.ID
    LEFT JOIN TEST_CONFIGS ON TESTS.TEST_CONFIG_ID = TEST_CONFIGS.ID
    JOIN JOBS ON TEST_RUNS.JOB_ID = JOBS.ID
    JOIN TEST_SUITES ON TEST_RUNS.TEST_SUITE_ID = TEST_SUITES.ID
  WHERE TESTS.CREATED_AT >= date_trunc('day', current_date) AND
        TEST_RUNS.STARTED_AT >= date_trunc('day', current_date) AND
        TESTS.STATUS = 'FAILED'
  GROUP BY PROJECTS.NAME, TESTS.ID, TEST_RUNS.ID, USERS.ID, TEST_RUNS.ENV, TEST_CONFIGS.PLATFORM, TEST_CONFIGS.BROWSER, TEST_RUNS.BUILD_NUMBER, TEST_CONFIGS.URL, TEST_SUITES.NAME, JOBS.NAME, JOBS.JOB_URL
);

select add_version(83);