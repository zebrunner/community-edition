set schema 'zafira';
select check_version(95);

DROP TABLE IF EXISTS INVITATIONS;
CREATE TABLE IF NOT EXISTS INVITATIONS (
  ID SERIAL,
  EMAIL VARCHAR(50) NOT NULL,
  TOKEN VARCHAR(255) NOT NULL,
  STATUS VARCHAR(50) NOT NULL,
  USER_ID INT NOT NULL,
  GROUP_ID INT NOT NULL,
  MODIFIED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (ID) ,
  CONSTRAINT fk_INVITATIONS_USERS1
  FOREIGN KEY (USER_ID)
  REFERENCES USERS (ID)
  ON DELETE CASCADE
  ON UPDATE NO ACTION,
  CONSTRAINT fk_INVITATIONS_GROUPS1
  FOREIGN KEY (GROUP_ID)
  REFERENCES GROUPS (ID)
  ON DELETE CASCADE
  ON UPDATE NO ACTION);
CREATE INDEX fk_INVITATIONS_USERS1_idx ON INVITATIONS (USER_ID);
CREATE INDEX fk_INVITATIONS_GROUPS1_idx ON INVITATIONS (GROUP_ID);
CREATE UNIQUE INDEX EMAIL_UNIQUE ON INVITATIONS (EMAIL);
CREATE UNIQUE INDEX TOKEN_UNIQUE ON INVITATIONS (TOKEN);
CREATE TRIGGER update_timestamp_invitations BEFORE INSERT OR UPDATE ON INVITATIONS FOR EACH ROW EXECUTE PROCEDURE update_timestamp();

ALTER TABLE USERS ADD COLUMN SOURCE VARCHAR(20) NOT NULL DEFAULT 'INTERNAL';

INSERT INTO PERMISSIONS (NAME, BLOCK) VALUES
				('INVITE_USERS', 'INVITATIONS'),
				('MODIFY_INVITATIONS', 'INVITATIONS');



select add_version(95);
