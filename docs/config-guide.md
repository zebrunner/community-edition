# Configuration Guide
   
## Organization Setup        
### Register Organization
   
  * Open Jenkins->Management_Jobs folder.
  * Run "RegisterOrganization" providing your SCM (GitHub) organization name as folderName and/or generated Sonarqube token
  * New folder is created with default content   
 
 Create organization: 
 ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/organization.png?raw=true "Organization")

### Register Repository
   * Open your organization folder
   * Run "RegisterRepository" pointing to your TestNG repository (use https://github.com/qaprosoft/carina-demo as sample repo to scan)
   -> Repository is scanned and TestNG jobs created
     
Create Repository:
 ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Repository.png?raw=true "Repository")       

#### Setup GitHub WebHook (onPush Job/Event)
   * Go to your GitHub repository
   * Click "Settings" tab
   * Click "Webhooks" menu option
   * Click "Add webhook" button
   * Type http://your-jenkins-domain.com/jenkins/github-webhook/ into "Payload URL" field
   * Select application/json in "Content Type" field
   * Tick "Send me everything." option
   * Click "Add webhook" button
   
#### Trigger onPush Job(s)
   *  After any push or merge into the master onPush-repo job is launched, suites scanned, TestNG jobs created

### Set up "GitHub Pull Request Builder":
   * Open Jenkins -> Credentials
   * Update Username and Password for "ghprbhook-token" credentials   
![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Credentials.png?raw=true "Credentials") 

  *  Go to Manage Jenkins -> Configure System
  *  Specify a value for GitHub Server API URL, for example, https://api.github.com
> Note: corporate versions of GitHub should have a different value, for example, https://github.mydomain.com/api/v3
  *  Provide GitHub credentials with Admin privileges for your organization
  *  Check the "Auto-manage webhooks" param
  * [Optional] update "Commit Status Context" to a value such as qps-infra to identify that changes in GitHub PR are automatically generated by infra
  *  Save changes
> Note: be sure to test integration through the Jenkins UI

### Restart Jenkins after Update Github Personal access token
> Note: generate new Personal access token in Github

  *  Go to Jenkins -> Credentials
  *  Updade credentials in Jenkins
  *  Restart Jenkins
  *  Open/Close Pull request in Github or create a new PL -> Verify that Pull request jobs are executed

#### Test the integration with Github through the Jenkins UI
  *  Set Credentials -> Test basic connection to GitHub
  *  Set Repository owner/name -> Test Permissions to a Repository
  *  Set Issue ID/Comment -> Test adding comment to Pull Request

![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/TestGithub.png?raw=true "TestGithub") 

#### Send Pull request to launch onPullRequest Job(s)
   * Go to your GitHub repository
   * Create new Pull Request -> onPullRequest-repo, onPullRequest-repo-trigger jobs launched and succeed in Jenkins
        
![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/PushJobs.png?raw=true "PushJobs")

## SonarQube Integration

To enable sonarqube integration need to have the following components configured correctly

### Generate Sonarqube token

  <ul>
  <li> Open your.domain.com/sonarqube 
  <li> Login with admin/admin(default) or your own credentials
  <li type="circle"> Change password if you need [Optional]
  <li> Generate user token (login icon -> My account -> security)
  </ul>
   
### Set up sonar credentials in Jenkins
  <ul>
   <li> Open Manage jenkins -> Credentials -> System -> Global Credentials
   <li> Add Credentials: Kind = secrect text, Secret = your sonar token, ID = sonar-token, Description = sonar-admin 
   ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/jenkins-sonar-cred.png?raw=true "sonar-credential")
   <li> Go to Manage Jenkins -> Configure System -> SonarQube servers 
   <li> Assign the new credential to Server and Save
   ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/jenkins-sonar-sv-config.png?raw=true "sonar-sv-config")
   </ul>
   
### Configure SonarQube configuration file for enabling static code analysis
  <ul>
  <li> Create a file named **.sonarqube**  in your project root directory 
  <li> Add the following properties (example from carina-demo):
   
  ```
  sonar.projectBaseDir=.
  sonar.projectName=carina-demo
  sonar.projectKey=carina-demo
  sonar.java.source=1.8
  sonar.sources=src/main
  sonar.tests=src/test
  sonar.java.binaries=target/classes
  sonar.junit.reportPaths=target/surefire-reports
  ```
  <li> Add the following property above the file (for multi-module maven projects):
 
  ```
  sonar.modules=carina-api,carina-aws-s3,carina-commons,carina-core,carina-crypto,carina-
  dataprovider,carina-appcenter,carina-proxy,carina-reporting,carina-utils,carina-webdriver
  ```
  </ul>
  > Note: For each push or pull request on your repository the sonar scanner will be executed.
  
### Pull request decoration
In order to enable pull request decoration(auto comments with sonar issues in the pr) follow the next steps:
<ul>
   <li> Create a new token for your github account with the following permissions
![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Github-sonar-token.png?raw=true "github-sonar-token")
   <li> When running registerOrganization job add the generated token under **sonarGithubOAuth**
![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/RegisterOrganization.png?raw=true "register-organization")
   <li> Pull request created/reopened -> sonar issues published with the user linked to the provided github token as in line comments.
</ul>

## Source Control Tools Integration
  For enterprise github or gitlab, you can declare the following global variables in Jenkins and the entire infrastructure will use them immediately by default:
 <ul>
   <li>  Manage jenkins -> Configure system 
   <li>  Global properties -> Add property 
       <ul>
       <li type="circle"> GITHUB_API_URL -> https://$GITHUB_HOST/api/v3 
       <li type="circle"> GITHUB_HOST -> github.mydomain.com 
       <li type="circle"> GITHUB_HTML_URL -> https://$GITHUB_HOST/$GITHUB_ORGANIZATION 
       <li type="circle"> GITHUB_ORGANIZATION -> myorganization 
       <li type="circle"> GITHUB_SSH_URL -> git@$GITHUB_HOST:$GITHUB_ORGANIZATION 
       </ul>   
 </ul>
 
![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Enterprise.png?raw=true "Enterprise") 

## Troubleshooting

## Support Channel

  * Join [Telegram channel](https://t.me/qps_infra) in case of any question
