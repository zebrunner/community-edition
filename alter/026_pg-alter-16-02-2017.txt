SET SCHEMA 'zafira';

DROP TRIGGER update_timestamp_test_runs ON zafira.test_runs;

--TEST_RUNS
DROP INDEX IF EXISTS TEST_RUNS_PLATFORM_INDEX;

UPDATE TEST_RUNS SET PLATFORM=NULL WHERE PLATFORM='NULL';

CREATE INDEX TEST_RUNS_PLATFORM_INDEX ON TEST_RUNS (PLATFORM);

CREATE TRIGGER update_timestamp_test_runs
  BEFORE INSERT OR UPDATE
  ON zafira.test_runs
  FOR EACH ROW
  EXECUTE PROCEDURE zafira.update_timestamp();



--there is no default timestamp trigger for some reason
DROP TRIGGER IF EXISTS update_timestamp_test_configs ON zafira.test_configs;
DROP TRIGGER IF EXISTS update_timestamp_test_configs ON zafira.tests;

--TEST_CONFIGS
DROP INDEX IF EXISTS TEST_CONFIGS_PLATFORM_INDEX;
DROP INDEX IF EXISTS TEST_CONFIGS_BROWSER_INDEX;

UPDATE TEST_CONFIGS SET PLATFORM=NULL WHERE PLATFORM='NULL';
UPDATE TEST_CONFIGS SET PLATFORM=NULL WHERE PLATFORM='';

UPDATE TEST_CONFIGS SET BROWSER=NULL WHERE BROWSER='NULL';
UPDATE TEST_CONFIGS SET BROWSER=NULL WHERE BROWSER='';


CREATE INDEX TEST_CONFIGS_PLATFORM_INDEX ON TEST_CONFIGS (PLATFORM);
CREATE INDEX TEST_CONFIGS_BROWSER_INDEX ON TEST_CONFIGS (BROWSER);

CREATE TRIGGER update_timestamp_test_configs
  BEFORE INSERT OR UPDATE
  ON zafira.test_configs
  FOR EACH ROW
  EXECUTE PROCEDURE zafira.update_timestamp();
