SET SCHEMA 'zafira';

ALTER TABLE WORK_ITEMS ADD COLUMN TYPE VARCHAR(45) NOT NULL DEFAULT 'TASK';
ALTER TABLE WORK_ITEMS ADD COLUMN HASH_CODE INT NULL;
ALTER TABLE WORK_ITEMS ADD COLUMN DESCRIPTION TEXT NULL;
ALTER TABLE WORK_ITEMS ADD COLUMN USER_ID INT NULL;
ALTER TABLE WORK_ITEMS ADD COLUMN TEST_CASE_ID INT NULL;
ALTER TABLE TESTS ADD COLUMN KNOWN_ISSUE BOOLEAN NOT NULL DEFAULT FALSE;
ALTER TABLE WORK_ITEMS ADD CONSTRAINT fk_WORK_ITEMS_USERS1 FOREIGN KEY (USER_ID) REFERENCES USERS (ID) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE WORK_ITEMS ADD CONSTRAINT fk_WORK_ITEMS_TEST_CASES1 FOREIGN KEY (TEST_CASE_ID) REFERENCES TEST_CASES (ID) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE TEST_WORK_ITEMS DROP CONSTRAINT fk_TEST_WORK_ITEMS_WORK_ITEMS1;
ALTER TABLE TEST_WORK_ITEMS ADD CONSTRAINT fk_TEST_WORK_ITEMS_WORK_ITEMS1 FOREIGN KEY (WORK_ITEM_ID) REFERENCES WORK_ITEMS (ID) ON DELETE CASCADE ON UPDATE NO ACTION;
CREATE UNIQUE INDEX WORK_ITEM_UNIQUE ON WORK_ITEMS (JIRA_ID, TYPE, HASH_CODE);
CREATE INDEX FK_WORK_ITEM_USER_ASC ON WORK_ITEMS (USER_ID);
CREATE INDEX FK_WORK_ITEM_TEST_CASE_ASC ON WORK_ITEMS (TEST_CASE_ID);
DROP INDEX JIRA_ID_UNIQUE;
INSERT INTO SETTINGS (NAME, VALUE) VALUES ('JIRA_URL', '');
