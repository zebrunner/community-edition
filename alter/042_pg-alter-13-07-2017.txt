SET SCHEMA 'zafira';


-- Phase 1
ALTER TABLE TEST_CASES ADD COLUMN PRIMARY_OWNER_ID INT NULL;
ALTER TABLE TEST_CASES ADD CONSTRAINT fk_TEST_CASES_PRIMARY_OWNER
  FOREIGN KEY (PRIMARY_OWNER_ID)
  REFERENCES USERS (ID)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
CREATE INDEX FK_TEST_CASE_PRIMARY_OWNER_ASC ON TEST_CASES (PRIMARY_OWNER_ID);


ALTER TABLE TEST_CASES ADD COLUMN SECONDARY_OWNER_ID INT NULL;
ALTER TABLE TEST_CASES ADD CONSTRAINT fk_TEST_CASES_SECONDARY_OWNER
  FOREIGN KEY (SECONDARY_OWNER_ID)
  REFERENCES USERS (ID)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
CREATE INDEX FK_TEST_CASE_SECONDARY_OWNER_ASC ON TEST_CASES (SECONDARY_OWNER_ID);

-- Phase 2
UPDATE TEST_CASES SET PRIMARY_OWNER_ID = USER_ID WHERE ID > 0;

-- Phase 3
ALTER TABLE TEST_CASES DROP CONSTRAINT fk_TEST_CASES_USERS1;
DROP INDEX FK_TEST_CASE_USER_ASC;
ALTER TABLE TEST_CASES DROP COLUMN USER_ID;
