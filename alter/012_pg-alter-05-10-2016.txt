SET SCHEMA 'zafira';

ALTER TABLE USERS DROP COLUMN IF EXISTS PROJECT;
ALTER TABLE TEST_SUITES DROP COLUMN IF EXISTS PROJECT;
ALTER TABLE TEST_CASES DROP COLUMN IF EXISTS PROJECT;
ALTER TABLE JOBS DROP COLUMN IF EXISTS PROJECT;
ALTER TABLE TEST_RUNS DROP COLUMN IF EXISTS PROJECT;
ALTER TABLE TESTS DROP COLUMN IF EXISTS PROJECT;

DROP TABLE IF EXISTS PROJECTS;
CREATE TABLE IF NOT EXISTS PROJECTS (
  ID SERIAL,
  NAME VARCHAR(255) NOT NULL,
  DESCRIPTION TEXT NULL,
  MODIFIED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (ID));  
CREATE UNIQUE INDEX NAME_UNIQUE ON PROJECTS (NAME);
CREATE TRIGGER update_timestamp_projects BEFORE INSERT OR UPDATE ON PROJECTS
    FOR EACH ROW EXECUTE PROCEDURE update_timestamp();

ALTER TABLE TEST_RUNS ADD COLUMN PROJECT_ID INT;
ALTER TABLE TEST_CASES ADD COLUMN PROJECT_ID INT;

ALTER TABLE TEST_CASES ADD CONSTRAINT fk_TEST_CASES_PROJECTS1 FOREIGN KEY (PROJECT_ID) REFERENCES PROJECTS (ID) ON DELETE NO ACTION ON UPDATE NO ACTION;
CREATE INDEX FK_TEST_CASES_PROJECTS_ASC ON TEST_CASES (PROJECT_ID);

ALTER TABLE TEST_RUNS ADD CONSTRAINT fk_TEST_RUNS_PROJECTS1 FOREIGN KEY (PROJECT_ID) REFERENCES PROJECTS (ID) ON DELETE NO ACTION ON UPDATE NO ACTION;
CREATE INDEX fk_TEST_RUNS_PROJECTS1_idx ON TEST_RUNS (PROJECT_ID);
