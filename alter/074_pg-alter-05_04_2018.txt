set schema 'zafira';

INSERT INTO zafira.SETTINGS (NAME, VALUE, TOOL) VALUES
  ('LAST_ALTER_VERSION', '0', NULL);

CREATE OR REPLACE FUNCTION check_version(INTEGER) RETURNS VOID AS $$
DECLARE CURRENT_VERSION zafira.SETTINGS.VALUE%TYPE;
BEGIN
  CURRENT_VERSION := (SELECT VALUE FROM SETTINGS WHERE NAME = 'LAST_ALTER_VERSION');
  IF (SELECT to_number(CURRENT_VERSION, '9999') + 1 != $1 AND CURRENT_VERSION != '0') THEN
    RAISE EXCEPTION 'Alter table can not be executed. Expected version is "%". Actual version is "%".', to_number(CURRENT_VERSION, '9999') + 1, $1;
  END IF;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION add_version(INT) RETURNS VOID AS $$
DECLARE CURRENT_VERSION zafira.SETTINGS.VALUE%TYPE;
BEGIN
  CURRENT_VERSION := to_char($1, '9999');
  UPDATE SETTINGS SET VALUE = CURRENT_VERSION WHERE NAME = 'LAST_ALTER_VERSION';
END;
$$ LANGUAGE plpgsql;

select add_version(74);